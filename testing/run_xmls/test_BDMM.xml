<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<beast version="2.5" namespace="
                                :beast.base.inference.parameter
                                :beast.evolution.tree.coalescent
                                :beast.base.evolution.operator
                                :beast.base.inference.operator.kernel
                                :beast.base.inference
                                :bdmmprime.distribution
                                :bdmmprime.parameterization
                                :bdmmprime.util.operators
                                :bdmmprime.util.priors
                                :feast.fileio">

    <map name="Uniform" >beast.base.inference.distribution.Uniform</map>
    <map name="Exponential" >beast.base.inference.distribution.Exponential</map>
    <map name="LogNormal" >beast.base.inference.distribution.LogNormalDistributionModel</map>
    <map name="Normal" >beast.base.inference.distribution.Normal</map>
    <map name="Beta" >beast.base.inference.distribution.Beta</map>
    <map name="Gamma" >beast.base.inference.distribution.Gamma</map>
    <map name="LaplaceDistribution" >beast.base.inference.distribution.LaplaceDistribution</map>
    <map name="prior" >beast.base.inference.distribution.Prior</map>
    <map name="InverseGamma" >beast.base.inference.distribution.InverseGamma</map>
    <map name="OneOnX" >beast.base.inference.distribution.OneOnX</map>

    <tree id="tree"
          spec="feast.fileio.TreeFromNewickFile" fileName="$(treeFile)"
          IsLabelledNewick="true" adjustTipHeights="false">
    </tree>

    <changeTimes id="changeTimes" spec="RealParameter" value="0.13 0.17"/>
    <parameter id="birthRate" spec="RealParameter" value="72"/>
    <parameter id="deathRate" spec="RealParameter" value="32"/>

    <run id="mcmc" spec="beast.base.inference.MCMC" chainLength="$(chainLength=100000)">
        <state id="state">
            <parameter id="origin" lower="0.0" name="stateNode">0.19932</parameter>
            <parameter spec="RealParameter" name="stateNode" id="samplingRate" value="0.1 0.1 0.1"/>
            <stateNode idref="tree"/>
        </state>

        <distribution id="posterior" spec="beast.base.inference.CompoundDistribution">
            <distribution id="likelihood" spec="beast.base.inference.CompoundDistribution">
                <distribution spec="BirthDeathMigrationDistribution" id="treePrior"
                              tree="@tree" conditionOnSurvival="true">
                    <parameterization spec="CanonicalParameterization"
                                      processLength="@origin" >
                        <birthRate spec="SkylineVectorParameter"
                                   skylineValues="@birthRate"
                                   timesAreAges="true" processLength="@origin" />
                        <deathRate spec="SkylineVectorParameter"
                                   skylineValues="@deathRate"
                                   timesAreAges="true" processLength="@origin" />
                        <samplingRate id="samplingRateSV" spec="SkylineVectorParameter"
                                      changeTimes="@changeTimes"
                                      timesAreAges="false" processLength="@origin">
                            <skylineValues idref="samplingRate" />
                        </samplingRate>
                        <removalProb spec="SkylineVectorParameter">
                            <skylineValues spec="RealParameter" value="1.0"/>
                        </removalProb>
                    </parameterization>
                </distribution>
            </distribution>

            <distribution id="prior" spec="beast.base.inference.CompoundDistribution">
                <prior id="samplingRatePrior" name="distribution" x="@samplingRate">
                    <Uniform name="distr" upper="10"/>
                </prior>
            </distribution>
        </distribution>


        <operator id="samplingRateScaler" spec="BactrianRandomWalkOperator" parameter="@samplingRate" weight="30.0" scaleFactor="0.75"/>


        <logger id="tracelog" spec="Logger" fileName="$(filebase)_$(seed).log" logEvery="$(logEvery=50)" model="@posterior" sanitiseHeaders="true" sort="smart">
            <log idref="posterior"/>
            <log idref="likelihood"/>
            <log idref="prior"/>
            <!--  parameters -->
            <log idref="treePrior"/>
            <log idref="birthRate"/>
            <log idref="samplingRateSV"/>
            <log idref="origin"/>
        </logger>

        <logger id="screenlog" spec="Logger" logEvery="$(logEvery)">
            <log idref="posterior"/>
            <log arg="@posterior" id="ESS_posterior" spec="util.ESS"/>
            <log idref="likelihood"/>
            <log arg="@likelihood" id="ESS_likelihood" spec="util.ESS"/>
            <log idref="prior"/>
            <log arg="@prior" id="ESS_prior" spec="util.ESS"/>
            <log idref="samplingRateSV"/>
        </logger>

    </run>

</beast>